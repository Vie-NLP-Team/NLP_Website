<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.opinion.viopinion.dao.ArticleDao">

    <resultMap type="com.opinion.viopinion.entity.Article" id="ArticleMap">

        <result property="id" column="id" jdbcType="INTEGER"/>

        <result property="title" column="title" jdbcType="VARCHAR"/>

        <result property="pubTime" column="pub_time" jdbcType="TIMESTAMP"/>

        <result property="images" column="images" jdbcType="VARCHAR"/>

        <result property="abstract1" column="abstract1" jdbcType="VARCHAR"/>

        <result property="keywords" column="keywords" jdbcType="VARCHAR"/>

        <result property="body" column="body" jdbcType="VARCHAR"/>

        <result property="category1" column="category1" jdbcType="VARCHAR"/>

        <result property="category2" column="category2" jdbcType="VARCHAR"/>

        <result property="websiteId" column="website_id" jdbcType="INTEGER"/>

        <result property="languageId" column="language_id" jdbcType="VARCHAR"/>

        <result property="requestUrl" column="request_url" jdbcType="VARCHAR"/>

        <result property="responseUrl" column="response_url" jdbcType="VARCHAR"/>

        <result property="coleTime" column="cole_time" jdbcType="TIMESTAMP"/>

        <result property="md5" column="md5" jdbcType="VARCHAR"/>

        <result property="html" column="html" jdbcType="VARCHAR"/>


        <result property="web_name" column="web_name" jdbcType="VARCHAR"/>

        <result property="article_count" column="article_count" jdbcType="INTEGER"/>

    </resultMap>


    <resultMap type="com.opinion.viopinion.entity.Web" id="WebMap">

        <result property="web_name" column="web_name" jdbcType="VARCHAR"/>

        <result property="article_count" column="article_count" jdbcType="INTEGER"/>

        <result property="sentiment_count" column="sentiment_count" jdbcType="INTEGER"/>

        <result property="sentiment" column="sentiment" jdbcType="INTEGER"/>

        <result property="monthevent" column="monthevent" jdbcType="INTEGER"/>

    </resultMap>

    <!--查询单个-->
    <select id="queryById" resultMap="ArticleMap">
        select
          id, title, pub_time, images, abstract1, keywords, body, category1, category2, website_id, language_id, request_url, response_url, cole_time, md5, html
        from article
        where id = #{id}
    </select>

    <select id="queryByBody" resultMap="ArticleMap">
        select
        id, title, pub_time, images, abstract1, keywords, body, category1, category2, website_id
        from article
        <where>
            <if test="body !=null">
                and body like "%"#{name,jdbcType=VARCHAR}"%"
            </if>
        </where>
    </select>

    <!--查询指定行数据-->
    <select id="queryAllByLimit" resultMap="ArticleMap">
        select
          id, title, pub_time, images, abstract1, keywords, body, category1, category2, website_id, language_id, request_url, response_url, cole_time, md5, html
        from article
        <where>
            <if test="id != null">
                and id = #{id}
            </if>
            <if test="title != null and title != ''">
                and title = #{title}
            </if>
            <if test="pubTime != null">
                and pub_time = #{pubTime}
            </if>
            <if test="images != null and images != ''">
                and images = #{images}
            </if>
            <if test="abstract1 != null and abstract1 != ''">
                and abstract1 = #{abstract1}
            </if>
            <if test="keywords != null and keywords != ''">
                and keywords = #{keywords}
            </if>
            <if test="body != null and body != ''">
                and body = #{body}
            </if>
            <if test="category1 != null and category1 != ''">
                and category1 = #{category1}
            </if>
            <if test="category2 != null and category2 != ''">
                and category2 = #{category2}
            </if>
            <if test="websiteId != null">
                and website_id = #{websiteId}
            </if>
            <if test="languageId != null and languageId != ''">
                and language_id = #{languageId}
            </if>
            <if test="requestUrl != null and requestUrl != ''">
                and request_url = #{requestUrl}
            </if>
            <if test="responseUrl != null and responseUrl != ''">
                and response_url = #{responseUrl}
            </if>
            <if test="coleTime != null">
                and cole_time = #{coleTime}
            </if>
            <if test="md5 != null and md5 != ''">
                and md5 = #{md5}
            </if>
            <if test="html != null and html != ''">
                and html = #{html}
            </if>
        </where>
        limit #{pageable.offset}, #{pageable.pageSize}
    </select>

    <!--统计总行数-->
    <select id="count" resultType="java.lang.Long">
        select count(1)
        from article
        <where>
            <if test="id != null">
                and id = #{id}
            </if>
            <if test="title != null and title != ''">
                and title = #{title}
            </if>
            <if test="pubTime != null">
                and pub_time = #{pubTime}
            </if>
            <if test="images != null and images != ''">
                and images = #{images}
            </if>
            <if test="abstract1 != null and abstract1 != ''">
                and abstract1 = #{abstract1}
            </if>
            <if test="keywords != null and keywords != ''">
                and keywords = #{keywords}
            </if>
            <if test="body != null and body != ''">
                and body = #{body}
            </if>
            <if test="category1 != null and category1 != ''">
                and category1 = #{category1}
            </if>
            <if test="category2 != null and category2 != ''">
                and category2 = #{category2}
            </if>
            <if test="websiteId != null">
                and website_id = #{websiteId}
            </if>
            <if test="languageId != null and languageId != ''">
                and language_id = #{languageId}
            </if>
            <if test="requestUrl != null and requestUrl != ''">
                and request_url = #{requestUrl}
            </if>
            <if test="responseUrl != null and responseUrl != ''">
                and response_url = #{responseUrl}
            </if>
            <if test="coleTime != null">
                and cole_time = #{coleTime}
            </if>
            <if test="md5 != null and md5 != ''">
                and md5 = #{md5}
            </if>
            <if test="html != null and html != ''">
                and html = #{html}
            </if>
        </where>
    </select>

    <!--新增所有列-->
    <insert id="insert" keyProperty="id" useGeneratedKeys="true">
        insert into article(title, pub_time, images, abstract1, keywords, body, category1, category2, website_id, language_id, request_url, response_url, cole_time, md5, html)
        values (#{title}, #{pubTime}, #{images}, #{abstract1}, #{keywords}, #{body}, #{category1}, #{category2}, #{websiteId}, #{languageId}, #{requestUrl}, #{responseUrl}, #{coleTime}, #{md5}, #{html})
    </insert>

    <insert id="insertBatch" keyProperty="id" useGeneratedKeys="true">
        insert into article(title, pub_time, images, abstract1, keywords, body, category1, category2, website_id, language_id, request_url, response_url, cole_time, md5, html)
        values
        <foreach collection="entities" item="entity" separator=",">
        (#{entity.title}, #{entity.pubTime}, #{entity.images}, #{entity.abstract1}, #{entity.keywords}, #{entity.body}, #{entity.category1}, #{entity.category2}, #{entity.websiteId}, #{entity.languageId}, #{entity.requestUrl}, #{entity.responseUrl}, #{entity.coleTime}, #{entity.md5}, #{entity.html})
        </foreach>
    </insert>

    <insert id="insertOrUpdateBatch" keyProperty="id" useGeneratedKeys="true">
        insert into article(title, pub_time, images, abstract1, keywords, body, category1, category2, website_id, language_id, request_url, response_url, cole_time, md5, html)
        values
        <foreach collection="entities" item="entity" separator=",">
            (#{entity.title}, #{entity.pubTime}, #{entity.images}, #{entity.abstract1}, #{entity.keywords}, #{entity.body}, #{entity.category1}, #{entity.category2}, #{entity.websiteId}, #{entity.languageId}, #{entity.requestUrl}, #{entity.responseUrl}, #{entity.coleTime}, #{entity.md5}, #{entity.html})
        </foreach>
        on duplicate key update
        title = values(title),
        pub_time = values(pub_time),
        images = values(images),
        abstract1 = values(abstract1),
        keywords = values(keywords),
        body = values(body),
        category1 = values(category1),
        category2 = values(category2),
        website_id = values(website_id),
        language_id = values(language_id),
        request_url = values(request_url),
        response_url = values(response_url),
        cole_time = values(cole_time),
        md5 = values(md5),
        html = values(html)
    </insert>

    <!--通过主键修改数据-->
    <update id="update">
        update article
        <set>
            <if test="title != null and title != ''">
                title = #{title},
            </if>
            <if test="pubTime != null">
                pub_time = #{pubTime},
            </if>
            <if test="images != null and images != ''">
                images = #{images},
            </if>
            <if test="abstract1 != null and abstract1 != ''">
                abstract1 = #{abstract1},
            </if>
            <if test="keywords != null and keywords != ''">
                keywords = #{keywords},
            </if>
            <if test="body != null and body != ''">
                body = #{body},
            </if>
            <if test="category1 != null and category1 != ''">
                category1 = #{category1},
            </if>
            <if test="category2 != null and category2 != ''">
                category2 = #{category2},
            </if>
            <if test="websiteId != null">
                website_id = #{websiteId},
            </if>
            <if test="languageId != null and languageId != ''">
                language_id = #{languageId},
            </if>
            <if test="requestUrl != null and requestUrl != ''">
                request_url = #{requestUrl},
            </if>
            <if test="responseUrl != null and responseUrl != ''">
                response_url = #{responseUrl},
            </if>
            <if test="coleTime != null">
                cole_time = #{coleTime},
            </if>
            <if test="md5 != null and md5 != ''">
                md5 = #{md5},
            </if>
            <if test="html != null and html != ''">
                html = #{html},
            </if>
        </set>
        where id = #{id}
    </update>

    <!--通过主键删除-->
    <delete id="deleteById">
        delete from article where id = #{id}
    </delete>

    <!--新闻社统计部分-->

    <!--返回根据新闻社类别统计的文章的总数-->
    <select id="queryWebArticleSum" resultMap="WebMap">
        select web_name, article_count from (
            select website_id, web_name from website as `oper2` where website_id in (
                select website_id from (
                    select website_id, count(*) as article_count from article group by website_id having article_count > 0) as `oper1`)) as `oper4`
                inner join
                    (select website_id, count(*) as article_count from article group by website_id having article_count > 0) as `oper3`
                on `oper3`.website_id = `oper4`.website_id;
    </select>

    <!--返回根据新闻社类别统计的文章的正面或负面总数-->
    <select id="queryWebSenSum" resultMap="WebMap">
        select web_name, sentiment_count from (select website_id, count(*) as sentiment_count from (
            select * from article
                inner join
            montharticle
                on article.id = montharticle.m_id where sentiment = #{sentiment}) as `senoper1`
            group by website_id having sentiment_count > 0) as `senoper2`
                inner join
            website
                on `senoper2`.website_id = website.website_id;
    </select>

    <!--统计每个事件的各个新闻社的新闻数量-->

    <select id="queryWebSenEventSum" resultMap="WebMap">
        select web_name, count(*) as article_count from (select id, web_name from (select id, website_id, sentiment, monthevent from (select * from article
            inner join
        montharticle
            on article.id = montharticle.m_id where sentiment = #{sentiment}) as `event_senoper1` where monthevent = #{monthevent}) as `event_senoper2`
                inner join
            website
                on `event_senoper2`.website_id = website.website_id) as `event_senoper3` group by web_name having article_count > 0;
    </select>

</mapper>

